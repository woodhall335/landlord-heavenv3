# Notice Only E2E Proof Artifacts

This directory contains PDF artifacts generated by the Notice Only E2E proof script, demonstrating that all supported routes work end-to-end.

## Directory Structure

```
artifacts/notice_only/
├── england/
│   ├── section_8.pdf         # England Section 8 Notice
│   └── section_21.pdf         # England Section 21 Notice (Form 6A)
├── wales/
│   ├── wales_section_173.pdf  # Wales Section 173 Notice (no-fault)
│   └── wales_fault_based.pdf  # Wales Fault-Based Notice (breach/arrears)
├── scotland/
│   └── notice_to_leave.pdf    # Scotland Notice to Leave
└── README.md                  # This file
```

## How to Run the E2E Proof Script

### Prerequisites

1. **Development Server Running**:
   ```bash
   npm run dev
   ```
   The script expects the API to be available at `http://localhost:5000` (or set `NEXT_PUBLIC_SITE_URL`).

2. **Supabase Running**:
   ```bash
   npx supabase start
   ```
   Or configure remote Supabase with environment variables.

3. **Optional: Install pdf-parse for Full Validation**:
   ```bash
   npm install pdf-parse
   ```
   **Note**: The script will work without `pdf-parse`, but will use fallback validation (file size, PDF header, basic sanity checks). For full text validation (checking for expected phrases, forbidden patterns), install `pdf-parse`.

### Run the Script

```bash
npx tsx scripts/prove-notice-only-e2e.ts
```

### What the Script Does

For each supported Notice Only route:

1. **Creates a test case** in Supabase
2. **Submits minimal valid wizard answers** (hardcoded test data)
3. **Generates a preview PDF** via `/api/notice-only/preview/:caseId`
4. **Saves the PDF** to `artifacts/notice_only/<jurisdiction>/<route>.pdf`
5. **Validates the PDF**:
   - **With pdf-parse** (if installed): Extracts text and checks for expected phrases, forbidden patterns
   - **Without pdf-parse**: Validates PDF header, file size, checks for template errors (`undefined`, `{{`, `NULL`)

### Exit Codes

- **0**: All routes passed ✅
- **1**: One or more routes failed ❌

## Viewing the PDFs

### macOS
```bash
open artifacts/notice_only/england/section_8.pdf
```

### Linux
```bash
xdg-open artifacts/notice_only/england/section_8.pdf
```

### Windows
```bash
start artifacts/notice_only/england/section_8.pdf
```

### Or use your file browser
Navigate to `landlord-heavenv3/artifacts/notice_only/` and open the PDFs with your preferred PDF viewer.

## Supported Routes

### England
- **section_8**: Section 8 Notice Seeking Possession (Housing Act 1988)
- **section_21**: Section 21 Notice (Form 6A) - No-fault eviction

### Wales
- **wales_section_173**: Section 173 Landlord's Notice (Renting Homes Wales Act 2016) - No-fault
- **wales_fault_based**: Fault-Based Notice for breach of contract (rent arrears, ASB, etc.)

### Scotland
- **notice_to_leave**: Notice to Leave under Private Housing (Tenancies) (Scotland) Act 2016

## Validation Checklist

Each generated PDF is validated for:

✅ **File Size**: Minimum 40KB (indicates real content, not empty/error)
✅ **PDF Header**: Starts with `%PDF-` (valid PDF format)
✅ **Expected Phrases** (if pdf-parse available):
   - Jurisdiction-specific legal references (e.g., "Housing Act 1988", "Section 173", "Notice to Leave")
   - Landlord/tenant/contract holder names
   - Property addresses
   - Key legal terms

❌ **Forbidden Patterns**:
   - Template errors: `undefined`, `{{`, `}}`, `NULL`, `[object Object]`
   - Wrong jurisdiction terminology (e.g., "Section 21" in Wales PDF, "tenant" in Wales PDF instead of "contract holder")

## Troubleshooting

### Script fails: "Failed to create case"
- **Check**: Supabase is running and accessible
- **Check**: Environment variables are set correctly (`NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`)

### Script fails: "Preview API failed: 500"
- **Check**: Development server is running (`npm run dev`)
- **Check**: MQS YAML files exist for all jurisdictions (`config/mqs/notice_only/*.yaml`)
- **Check**: Templates exist for all routes (`config/jurisdictions/uk/*/templates/eviction/*.hbs`)

### PDF validation fails: "Missing expected phrase"
- **Review**: Open the PDF manually to verify it contains the expected content
- **Check**: Template variables are correctly mapped in the mapper file
- **Check**: Decision engine computes dates/values correctly

### Warning: "pdf-parse not installed"
- **Action**: Install with `npm install pdf-parse` for full text validation
- **Or**: Ignore if you're OK with fallback validation (the script will still pass/fail based on file size and basic sanity checks)

## Next Steps

After running the script successfully:

1. **Review the PDFs** manually to ensure they look correct
2. **Run the smoke tests** to verify jurisdiction matrix: `npx tsx scripts/smoke-jurisdiction-matrix.ts`
3. **Run unit tests** to verify mappers and decision engine: `npm test`
4. **Deploy** with confidence knowing all routes work end-to-end!

## Related Documentation

- **Notice Only Support Matrix**: `docs/NOTICE_ONLY_SUPPORT_MATRIX.md`
- **Field Mapping**: `docs/NOTICE_ONLY_FIELD_MAP.md`
- **Product Alignment Plan**: `docs/PRODUCT_ALIGNMENT_PLAN.md`
- **Audit Scripts**: `scripts/audit-legal-completeness.ts`, `scripts/smoke-jurisdiction-matrix.ts`
